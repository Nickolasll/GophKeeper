@startuml
!theme vibrant
title: 6.6. Синхронизация данных клиента и сервера
skinparam maxMessageSize 300
autonumber

participant "Пользователь" as user
box "Компьютер пользователя" #DEDEDE
    participant "CLI Клиент" as client
    database "Файловая система" as file
end box

box "GophKeeper" #d3f3fa
    participant "Обработчик запроса" as handler
    participant "Юзкейз синхронизации" as usecase
    participant "Служба шифрования" as crypto
    database "postgres" as db
end box

user -> client ++ : Вводит команду на синхронизацию данных
note over user, client
    GophKeeper sync
end note

ref over user, handler
    6.5. Авторизация пользователя на стороне клиента
end

client -> handler ++ : Отправляет запрос на синхронизацию данных
note over client, handler
    GET /api/sync HTTP/1.1
    Content-Type: application/json
    Authorization: Bearer ...
end note

group middleware
    note over user, handler: 6.4. Авторизация пользователя на стороне сервера
end group

handler -> usecase ++ : Вызывает поведение по синхронизации по идентификатору пользователя
usecase -> db ++ : Запрашивает данные пользователя
return Пользовательские данные
loop Итерируется по пользовательским данным
    usecase -> crypto ++ : Расшифровывает данные
    return Расшифрованные данные
end
return Пользовательские данные
return 200 OK
note over client, handler
    200 OK HTTP/1.1
    Content-Type: application/json
    
    
    {
        "passwords": [
             {
                 ...
             },
             ...
        ],
        ...
    }
end note

client -> file: Сохраняет данные в файл и шифрует его
activate file
deactivate file 
return Вывод сообщения об успехе исполнения команды
@enduml